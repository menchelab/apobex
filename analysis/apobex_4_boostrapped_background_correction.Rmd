# Bootstrapped Background Correction

```{r}
library(MutationalPatterns, quietly = TRUE)
library(BSgenome, quietly = TRUE)
library(BSgenome.Hsapiens.UCSC.hg38, quietly = TRUE)
ref_genome <- "BSgenome.Hsapiens.UCSC.hg38"
library(ref_genome, character.only = TRUE)
library("gridExtra", quietly = TRUE)
library(ggplot2, quietly = TRUE)
library(reshape2)
library(hash, quietly = TRUE)
library(matrixStats, quietly = TRUE)
library(mutSignatures, quietly = TRUE)
library(lsa, quietly = TRUE)
library(tidyverse)
library(dplyr)
library(ApobeX)
```




read in data (if already saved)
```{r}
results_path = '../stats_results'
setwd(results_path)
mut_mat = readRDS('../data/R_data_objects/mutation_matrix_apobex_4.4.RDS')
signatures = get_known_signatures()
sample_map = tibble(read.csv('../data/metadata/days_combined_sample_sheet.csv', sep = ";"))
```

visualize the total number of mutations in each genotype over time
first for control
the parent clones all have UNG -/- are:
bm = R2 (no apobec alterations)
bd = R2+219 (A3B knockout)
boost = RA1 (A3H overexpression) - like last time

bm = baseline middle (we expect intermediate signal)
bd = baseline down (we expect low signal)
boost = boosted (we expect high signal)

```{r}
library(glue) #like f strings

genotype = 'sgAAVS1'
clone = 'R2+219'

sample_names = retrieve_sample_names(sample_map, genotype = genotype, clone = clone)
data = subset_matrix_by_samples(mut_mat, sample_names)
data = reorder_matrix_columns(data, sample_names)
total = colSums(data)

# Create dynamic plot filename and title
plot_filename <- glue("total_mutations_plot_{clone}_{genotype}.png")
plot_title <- glue("total mutations {clone} {genotype}")

png(plot_filename)
barplot(total, main = plot_title,
        xlab = "Samples", ylab = "Total Mutations",
        cex.main = 1, cex.lab = 1, col = "salmon")
dev.off()

```


calculate bootstrapped background profile for each genotype (at timepoint 0)
save, the results, and plot the average background profile
bm = R2 (no apobec alterations)
bd = R2+219 (A3B knockout)
boost = RA1 (A3H overexpression) - like last time

```{r}
library(glue)

genotype = 'sgHUWE1'
clone = 'RA1'

#retrieve the sample names
samples_day0 = retrieve_sample_names(sample_map, genotype = genotype, clone = clone, culture_days = 'D0')
samples_day0

#slice and reorder mutation matrix
mut_day0 = subset_matrix_by_samples(mut_mat, samples_day0)
mut_day0 = reorder_matrix_columns(mut_day0, samples_day0)


#rescale matrix to the sample with the lowest mutation count
mut_day0 = scale_matrix(mut_day0)

bootstrapped_baseline = bootstrap_routine(mut_day0)
saveRDS(bootstrapped_baseline, file = glue('bootstrap_results_{clone}_{genotype}.RDS'))

#average boot results
average_bootstrapped_baseline = average_bootstrapped_samples(bootstrapped_baseline)

#pull results into matrix
average_bootstrapped_baseline_matrix = round(hash_to_average_matrix(average_bootstrapped_baseline))
#collapse the bootstrapped replicates into one profule
average_bootstrapped_baseline_matrix = round(rowMeans(average_bootstrapped_baseline_matrix))

saveRDS(average_bootstrapped_baseline_matrix, file = glue('bootstrapped_profile_mean_{clone}_{genotype}.RDS'))

#plot the bootstrapped profile
plot_filename <- glue("bootstrapped_profile_mean_{clone}_{genotype}.png")

plot_baseline = replicate(2, average_bootstrapped_baseline_matrix, simplify = 'matrix')

p = plot_96_profile(plot_baseline)
ggsave(plot_filename, p, width = 8, height = 6, units = "in", dpi = 300)

```

#correct each genotype (all other timepoint but D0) for the bootstrapped background profile and plot
the corrected profile for each sample and refit and save the plot

# results

```{r}
library(glue)

name_prefix = '0.004_best_subset'

# correct samples for bootstrapped baseline

#read in bootstrapped baseline
boot_path <- "../data/R_data_objects/apobex_4_bootstrap_background_data" # nolint: line_length_linter.
# List all files in the directory
bootstrap_files <- list.files(
  boot_path,
  full.names = FALSE
)

signatures = get_known_signatures()
#signature catalog
prior_knowledge_subset = signatures[,c(1,2,5,6,19,21,25)]

for (i in seq_along(bootstrap_files)){
  bootstrapped_baseline <- readRDS(glue("{boot_path}/{bootstrap_files[i]}"))
  # Extract clone names and genotypes from file names
  clone <- sapply(strsplit(bootstrap_files[i], "_"), function(x) x[4])
  genotype <- sapply(strsplit(bootstrap_files[i], "_"), function(x) gsub(".RDS", "", x[5])) # nolint: line_length_linter.

  #retrieve and order samples # nolint
  samples <- retrieve_sample_names(sample_map,
                                  genotype = genotype,
                                  clone = clone)

  #cut out day 0 samples that were already used in bootstrappping
# for R2+219 UBR5, this is only 2 samples!!!
if (clone == 'R2+219' & genotype == 'sgUBR5') {
    samples <- samples[-c(1:2)]
} else {
    samples <- samples[-c(1:3)]
}


#adjust the dimensions of the bootstrapped baseline
bootstrapped_baseline = rep(bootstrapped_baseline, length(samples))

#retrieve mutation data
mut_samples <- subset_matrix_by_samples(mut_mat, samples)
mut_samples <- reorder_matrix_columns(mut_samples, samples)

#rescale mutational matrix for controls
mut_samples_rescaled <- scale_matrix(mut_samples)

#correct for bootstrapped baseline
samples_corrected <- mut_samples - bootstrapped_baseline
samples_corrected <- pmax(samples_corrected, 0)

#refitting
best_subset_refit = fit_to_signatures_strict(samples_corrected, prior_knowledge_subset, max_delta = 0.004, method = "best_subset")
result = best_subset_refit$fit_res$contribution

#bootstrapped refitting
contri_boots = fit_to_signatures_bootstrapped(samples_corrected, prior_knowledge_subset, max_delta = 0.004, n_boots = 100, method = "strict_best_subset")
#results would have to be summarized and saved


#save out refit results into a single csv
write.csv(result, file = glue("{name_prefix}_signature_contribution_{clone}_{genotype}.csv"))
#plot
p1 = plot_contribution(result,
  coord_flip = FALSE,
  mode = "relative"
)

p2 = plot_contribution(result,
  coord_flip = FALSE,
  mode = "absolute"
)


p3 = plot_bootstrapped_contribution(contri_boots, mode = "relative", plot_type = "dotplot") 

p1_filename <- glue("relative_{name_prefix}_signature_contribution_mut{clone}_{genotype}.png")
p2_filename <- glue("absolute_{name_prefix}_signature_contribution_mut{clone}_{genotype}.png")
p3_filename <- glue("boot_{name_prefix}_signature_contribution_dot_{clone}_{genotype}.png")

ggsave(p1_filename, p1, width = 8, height = 6, units = "in", dpi = 300)
ggsave(p2_filename, p1, width = 8, height = 6, units = "in", dpi = 300)
ggsave(p3_filename, p3, width = 8, height = 6, units = "in", dpi = 300)

#plot the corrected profiles
plot_filename_p4 <- glue("{name_prefix}_background_corrected_{clone}_{genotype}.png")

p4 = plot_96_profile(samples_corrected)
ggsave(plot_filename_p4, p4, width = 8, height = 6, units = "in", dpi = 300)
  
log_file <- glue("{name_prefix}_correction_log.txt")
sink(log_file, append = TRUE)
print(glue("Background correction for {clone} {genotype} {length(samples)} {bootstrap_files[i]} {samples}"))
sink()
}
```


